<!DOCTYPE html>
<html lang='en'>
    <head>
        <style>
            h1 {
                text-align: center;
            }

            table {
                font-family: arial, sans-serif;
                font-size: 80%;
                margin-left: auto;
                margin-right: auto;
                border-collapse: collapse;
                width: 50%;
                white-space:nowrap;
            }

            td, th {
                border: 1px solid #dddddd;
                text-align: center;
                padding: 4px;
            }

            tr:nth-child(even) {
                background-color: #dddddd;
            }
        </style>
    </head>    

    <body>
        <div style="text-align:right; font-family:monospace;">    
            <p id="username">temp_user</p>
            <a href="/api/logout">Logout</a> 
        </div>

        <h1 style='font-family:monospace'>Web Movie Database</h1>

        <form style='text-align:center; font-family:monospace'>
            <input type='text' id='searchInput' size='60' placeholder='Search movies' >
            <button id='searchBtn'>Search</button>
        </form>

        <br></br>
    </body>

    <script>
        const usernameParagraph = document.getElementById('username')
        const searchInput = document.getElementById('searchInput')
        const searchBtn = document.getElementById('searchBtn')
        
        searchBtn.addEventListener('click', postSearch)

        // when page gets load, get session
        window.onload = (async function() {
            const options = {
                method: 'GET', 
                headers: { 'Content-Type': 'application/json'}
            }
            const response = await fetch('api/get_session');
            const data = await response.json()
        
            if (data.userid == undefined) window.location = "http://localhost:8080/login.html";
            usernameParagraph.innerHTML = data.userid;
        })();
        
        async function postSearch (e) {
            e.preventDefault()
            const options = {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: searchInput.value}) 
            }
            const response = await fetch('api/search_from_user', options);
            const data = await response.json()
            generateTable(data)
        }
        
        /* -------------------------------------------------------------- */
        // http://jsfiddle.net/QwBsa/12/
        async function generateTable(serverResponse) {
            const tableId = "movieTable";
            const titleRow  = ['Title', 'Release Date', 'Runtime', 'Genre', 'WMD Rating', 'Your Rating', 'Movie Status'];

            try { // delete table before generating it
                document.getElementById(tableId).remove()
            }
            catch (err) {
                console.log(err)
            }

            var body = document.body;
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var tbody = document.createElement('tbody');

            table.setAttribute("id", tableId);
            table.appendChild(thead);

            // generate table header
            for (var i = 0; i < titleRow.length; i++) {
                thead.appendChild(document.createElement('th')).
                appendChild(document.createTextNode(titleRow[i]));
            }
            
            // generate table body
            var formArray = [];
            var radioId = -1;
            serverResponse.forEach(key => {
                var row = document.createElement('tr');
                radioId += 1;

                for (let value in key) {
                    console.log(`${value}: ${key[value]}`);
                    var item = key[value];
                    var cell = document.createElement('td');
                    
                    if (value == 'wmd_rating') 
                    {
                        if (!item) item = '0/10 (0)'
                    } 
                    else if (value == 'user_rating') 
                    {
                        if (!item) item = 'Rate'
                    } 
                    else if (value == 'status') 
                    {   
                        var form = document.createElement('form');
                        form.name = `radiobox${radioId}`;
                        //form.addEventListener('')
                        // create radio button
                        const movie_status = ['Plan to Watch', 'Completed'];
                        for (let i = 0; i < movie_status.length; i++) {
                            // radiobox
                            var radiobutton = document.createElement('input'); radiobutton.type = 'radio';
                            radiobutton.id = `radios`;
                            radiobutton.addEventListener
                            //radiobox.checked = true; // change this as per database
                            
                            // (label <- text)
                            var label = document.createElement('label');
                            var text = document.createTextNode(movie_status[i]);
                            
                            //  cell <- form <__ (text is in label) 
                            //                \ radiobox
                            label.appendChild(text);
                            form.appendChild(radiobutton);
                            form.appendChild(label);
                            cell.appendChild(form);
                        }
                       // formArray[radioId] = 
                        row.appendChild(cell);
                        continue;
                    }
                    cell.textContent = item
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            body.appendChild(table);
        }
    </script>
</html>